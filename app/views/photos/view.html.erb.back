<%- model_class = Photo -%>

<!-- photo view and description -->
<div class="row-fluid" id="photo">
  <div class="span12">
    <div class="navbar">
      <!-- menubar for photo -->
      <div class="navbar-inner">
        <ul class="nav">
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Photo<b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><%= link_to 'Other Versions', photo_version_path(@persona.screen_name, @photo.id) %></li>
                <li><%= link_to 'Launch Editor', photo_editor_path(@photo.id) %></li>
                <li><%= link_to 'Exif Data', photo_view_exif_path(@persona.screen_name, @photo.id) %></li>
                <% if persona_signed_in? && current_persona.id == @persona.id then %>
                  <li><%= link_to 'Add/Remove to Mediaset', '#addToSetModal', :'data-toggle'=>'modal' %></li>
                  <li class="divider"></li>
                  <li><%= link_to 'Delete this photo', photo_path(@photo), 
                    :method => 'delete', 
                    :data => { :confirm => t('.confirm', :default => t("helpers.links.confirm", :default => 'Are you sure?')) }
                    %></li>
                <% end %>
              </ul>
          </li>
        </ul>
      </div>
    </div><!-- navbar -->
    <div id="photo_<%= @photo.id %>" class="carousel">  
      <!-- picture description -->
      <div class="carousel-inner">
        <div class="active item">
          <%= image_tag @photo.avatar.xlarge, :style=> 'margin-left:auto; margin-right:auto;' %>
          <div class="carousel-caption row-fluid">
            <div class="span7">
              <h4 id="photo-title"><%= @photo.title %>
                <small> by <%= link_to persona_signed_in? && 
                  current_persona == @persona ? 'you' : @persona.screen_name, persona_path(@persona.screen_name) %>
                </small>
              </h4>
              <% if persona_signed_in? && current_persona == @persona then %>
                <%= form_for @photo, :html => { :id=>'photo-title-form', :class=> 'form-horizontal' } do |f| %>
                  <%= f.text_field :title , :class=>'span6'%>
                  <%= link_to 'Cancel', '#', :id=>'photo-title-cancel-btn', :class=>'btn' %> 
                  <%= f.submit 'Update title', :class=>'btn btn-primary' %>
                <% end %>
              <% end %>
            </div>
            <div class="span5">
              <div class="row-fluid">
                <div class="row-fluid"> 
                  <div class="span12 progress">
                  <!-- the voting & featured stuff -->
                  <% total_votes = @photo.up_votes + @photo.down_votes %>
                    <% if total_votes == 0 then %>
                      <div class="bar bar-info" style="width:100%;"></div>
                    <% else %>
                      <div class="bar bar-success" style="width:<%= @photo.up_votes.to_f/total_votes * 100 %>%;">
                      </div>
                      <div class="bar bar-danger" style="width:<%= @photo.down_votes.to_f/total_votes * 100 %>%;">
                      </div>
                    <% end %>
                  </div>
                </div><!-- -->
                <div id="totalVoteBox" class="span5">
                  <h4><%= pluralize total_votes, 'vote' %> </h4>
                </div>
                <div  class="span6" >
                  <div id="featuredBox">
                    <% if current_persona == @persona then %>
                      <% theStar = @photo.featured ? 'icon-star' : 'icon-star-empty' %>
                      <%= link_to ('<i class="isFeatured '+ theStar +'"></i>').html_safe, 
                        photo_toggle_featured_path(@photo), :remote=>true, :method=>:post
                       %>
                    <% end %>
                  </div>
                  <div class="voteBox">
                    <h4>
                    <% if persona_signed_in? then %>
                      <% if current_persona.voted?(@photo) then %>
                        Voted 
                        <i class="icon-thumbs-<%= current_persona.up_voted?(@photo) ? 'up' : 'down' %>"></i>- 
                        <%= link_to 'unvote', photo_unvote_path(@photo,current_persona.screen_name), 
                          :remote => true, :method => :post %>
                      <% else %>
                        <%= link_to '<i class="icon-thumbs-up"></i>'.html_safe, 
                          photo_vote_path(@photo, 'up', current_persona.screen_name), 
                          :remote=>true, :method => :post %>
                        <%= link_to '<i class="icon-thumbs-down"></i>'.html_safe, 
                          photo_vote_path(@photo, 'down', current_persona.screen_name), 
                          :remote=>true, :method=>:post %>
                      <% end %>
                    <% else %>
                      <p>Login to Vote</p>
                    <% end %>
                  </div>
                </div><!-- row-fluid-->
              </div>
            </div>
            <div id="photo-desc" class="row-fluid" style="max-height:150px; overflow:auto;">
              <div class="span10">
              <%= simple_format(@photo.description.nil? ? 'No Description' : truncate(@photo.description)) %>
              </div>
            </div>
            <% if persona_signed_in? && current_persona.id == @persona.id then %>
              <%= form_for @photo, :html => { :id => 'photo-desc-form' } do |f| %>
                <%= f.text_area :description, :size => '80x6', :class=>'span9' %> 
                <br />
                <%= link_to 'Cancel', '#photo-desc', :id=>'photo-desc-cancel-btn', :class=>'btn' %>
                <%= f.submit nil, :class=>'btn btn-primary' %>
              <% end %>
            <% end %>
            </div><!-- carousel-caption -->
          </div><!-- active item -->
        </div><!-- corousel-inner -->
        <%= link_to '&lsaquo;'.html_safe,  @prev_photo.nil? ? '#' : photo_view_path(@persona.screen_name, 
          @prev_photo)+'#photo' , :class=>'carousel-control left' %>
        <%= link_to '&rsaquo;'.html_safe,  @next_photo.nil? ? '#' : photo_view_path(@persona.screen_name, 
          @next_photo)+'#photo' , :class=>'carousel-control right' %>
      </div><!--carousel-->
  </div><!-- span12 -->
</div><!-- row -->

<!-- photo coverflow -->
<div class="accordion" id="accordion2">
  <div class="accordion-group">
      <!-- show which mediasets this photo belongs to -->
    <div class="accordion-heading">
      <h3>
        <%= link_to '<i class="icon-chevron-down"></i>'.html_safe, '#collapseDefault', 
          :class=>'accordion-toggle', :'data-toggle'=>'collapse', :'data-parent'=>"#accordion2", 
          :style=>'display:inline;'  %><%= link_to 'Photos by '+@persona.screen_name, photo_path(@persona.screen_name, :view=>'raw') %>
      </h3>
    </div>
    <div class="accordion-body collapse" id="collapseDefault">
      <div class="accordion-inner">
          <% @photolist = get_photo_list(@persona.id, @photo.id, nil) %>
          <%= render "coverflow" %>
      </div>
    </div>
  </div>
  <% @photo.mediasets.each do |mediaset| %>
    <div class="accordion-group">  
      <div class="accordion-heading">
        <h3>
        <%= link_to '<i class="icon-chevron-down"></i>'.html_safe, '#collapse'+mediaset.id.to_s, 
          :class=>'accordion-toggle', :'data-toggle'=>'collapse', :'data-parent'=>'#accordion2', 
          :style=>'display:inline;' %><%= link_to mediaset.title, view_sets_path(@persona.screen_name, mediaset) %>
        </h3>
      </div>
      <div class="accordion-body collapse" id="collapse<%= mediaset.id %>">
        <% @photolist = get_photo_list(@persona.id, @photo.id, mediaset.id) %>
        <%= render "coverflow" %>
      </div>
    </div>
  <% end %>
</div>


<!-- modal for updating mediaset selection -->
<%= render "updateMediasetModal" %>

<% if persona_signed_in? && @persona.id == current_persona.id then %>
  <script type="text/javascript">
    //for owners of the photo
    $(document).ready(function(){
      //hide all the forms
      $("#photo-title-form").hide();
      $("#photo-desc-form").hide();
      
      //click event
      $("#photo-title").click(function (event){
        $("#photo-title").hide("slow");
        $("#photo-title-form").show("slow");
      });
      $("#photo-title-cancel-btn").click(function (event){
        $("#photo-title").show("slow");
        $("#photo-title-form").hide("slow");
      });
      $("#photo-desc").click(function (event){
        $("#photo-desc").hide("slow");
        $("#photo-desc-form").show("slow"); 
      });
      $("#photo-desc-cancel-btn").click(function (event){
        $("#photo-desc").show("slow");
        $("#photo-desc-form").hide("slow"); 
      });
    });
  </script>
<% end %>
<script type="text/javascript">
  //for normal users 
  $(document).ready(function(){
      //$('.carousel-caption').hide();
      $('.carousel-control').hide();
      $('.carousel').hover(
        function(){ 
          $('.carousel-caption').fadeIn('slow', '');
          $('.carousel-control').fadeIn('', '');
        }, function(){ 
          $('.carousel-caption').fadeOut('slow','');
          $('.carousel-control').fadeOut('', '');
        }
      );
  });

  $(document).keydown(function (e) {
    var keyCode = e.keyCode || e.which,
        arrow = {left: 37, up: 38, right: 39, down: 40 };

    switch (keyCode) {
      case arrow.left:
        $(location).attr('href', "<%= @prev_photo.nil? ? '#' :  photo_view_path(@persona.screen_name, @prev_photo) + '#photo' %>");
      break;
      case arrow.right:
        $(location).attr('href', "<%= @next_photo.nil? ? '#' : photo_view_path(@persona.screen_name, @next_photo)  + '#photo'%>");
      break;
    }
  });
</script>
