var handle = $('.endless_scroll_inner_wrap');

<% if  !@next_photos.empty? then %>

  //load the photos
  <% @next_photos.each do |photo| %>
    <% this_persona = Persona.find(photo.persona_id).screen_name %>
      var carousel = jQuery('<div/>', {class:'carousel', id:'carousel_<%= photo.id %>',  
        style:'float:left; margin: 0px 2px 2px 0px;'}).
        append(jQuery('<div/>', {class:'carousel-inner'}));
  
      carousel.append("<%= 
        escape_javascript(
          link_to image_tag(photo.avatar.versions[@options[:size].to_sym], 
            :class=>'img-polaroid', :id=> 'photo_' + photo.id.to_s ), 
          @options[:enableLinks] ? (@options[:mediatype] == 'mediaset' ? 
            photo_view_in_mediaset_path(this_persona, photo, params[:mediaset_id]) : 
            photo.featured ? photo_view_in_featured_path(this_persona, photo) : photo_view_path(this_persona, photo)) : '#'
        ) 
        %>"
      );

  <% if @options[:showCaption] then %>
    var caption = jQuery('<div/>', {class:'carousel-caption', style:'color:white'});
    caption.append(jQuery('<div/>',  {
      text:'<%= escape_javascript(truncate(photo.title, :length => 20)) %> by ', 
        class:'pull-left caption-text'
    }));
    caption.find('.caption-text').append(jQuery('<a/>', {text:'<%= this_persona %>', 
      href:'<%= escape_javascript(persona_path(this_persona)) %>'}));
    caption.append(jQuery('<div/>', {class:'caption-vote pull-right'}))
    <% if persona_signed_in? && current_persona.id == photo.persona_id then %>
      caption.find('.caption-vote').append(jQuery('<a/>', 
        {href:'<%= photo_toggle_featured_path(photo) %>', 'data-remote':'true', 
          'data-method':'post'}).append(jQuery('<i/> ', 
          {class:'isFeatured <%= photo.featured ? 'icon-star' : 'icon-star-empty' %>'}))); 
      caption.find('.caption-vote').find('a').append(' ');
    <% end %>
    var voteBox = jQuery('<div/>', {class:'pull-right voteBox'});
    <% if persona_signed_in? && !current_persona.voted?(photo) then %>
      voteBox.append(jQuery('<a/>', { href:'<%= escape_javascript photo_vote_path(photo, "up", 
        current_persona.screen_name) %>', 'data-remote':true, 'data-method':'post', 
        rel:'nofollow' }).append(jQuery('<i/>', {class:'icon-thumbs-up'})));
      voteBox.append(' ');
      voteBox.append(jQuery('<a/>', { href:'<%= escape_javascript photo_vote_path(photo, "down", 
        current_persona.screen_name) %>', 'data-remote':true, 'data-method':'post', 
        rel:'nofollow' }).append(jQuery('<i/>', {class:'icon-thumbs-down'})));
    <% elsif persona_signed_in? && current_persona.voted?(photo) then %>
      voteBox.append(jQuery('<a/>', {
        href:'<%= escape_javascript photo_unvote_path(photo, current_persona.screen_name) %>',
        'data-remote':true, 'data-method':'post', rel:'nofollow'}).append(jQuery('<i/>', { 
          class:'icon-thumbs-<%= current_persona.up_voted?(photo) ? "up" : "down" %>'} )
        )
      );
    <% end %>
    caption.append(voteBox);
    caption.wrapInner('<h5/>');
    carousel.append(caption);
  <% end %>

    $('.endless_scroll_inner_wrap').append(carousel);
    $('.endless-photos').attr('last', <%= @options[:mediatype] == 'mediaset' ? Mediaset.find(params[:mediaset_id]).mediaset_photos.where(:photo_id => @next_photos.last.id).first.order : @next_photos.last.id %>);

    $('.carousel-caption').hide();
    $('.carousel').hover( function(){
        $(this).find('.carousel-caption').show();
      }, function() {
        $(this).find('.carousel-caption').hide();
    });
  <% end %>
  
  //make it draggable
  <% if @options[:draggable] then %>
    handle.find('img').draggable(
      { 
        revert:'invalid', connectToSortable:'<%= @options[:dragSortConnect] %>'
      } 
    );
  <% end %>
<% else %>
  //remove the end 
  //handle.append(jQuery( '<div/>', {text:'That\'s all folks!!', class:'pull-left img-polaroid', style:'height:100px; ' } )); 
<% end %>
