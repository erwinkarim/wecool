<%- model_class = Mediaset -%>
<% @focus = 'mediaset' %>
<%= render "common/personaHeaderBar" %>

<div class="navbar">
  <div class="navbar-inner">
    <ul class="nav">
      <li class="divider-vertical"></li>
      <li><%= link_to t('.back', :default => t("helpers.links.back")), mediasets_path %>
      <% if persona_signed_in? && current_persona.screen_name == params[:id] %>
        <li class="divider-vertical"></li>
        <li><%= link_to 'New', new_mediaset_path %></li>
        <li class="divider-vertical"></li>
      <% end %>
    </li>
    </ul>
  </div>
</div>

<% if @persona.mediasets.empty? then %>
  <div class="well">
    <% if @persona.photos.empty? then %>
      <%= link_to 'Upload', new_photo_path %> some new photos to create a mediaset
    <% else %>
      <%= link_to 'Create', new_mediaset_path %> some new mediaset to help organize and showcase your photos
    <% end %>
  </div>
<% else %>
  <ul class="nav nav-tabs" id="mediasetTypeSelectorTab">
    <li class="active recentlyFeatured"><%= link_to 'Featured', '#' %></li>
    <li class="recentlyRaw"><%= link_to 'Raw', '#' %></li>
  </ul>
  <div class="row-fluid endless-mediaset" last="<%= Mediaset.last.id %>">
    <div class="last-div endless_scroll_inner_wrap" id="last-frame"></div>
  </div>
  <div class="row-fluid">
    <%= link_to 'Get More Mediasets', '#', :class=>'btn btn-primary', :id=>'getMoreSets' %>
  </div>
<% end %>
<script type="text/javascript">
  <% if !@persona.mediasets.empty? then %>
    isFeatured = true
    $.ajax({
      url: '/mediasets/get_more/<%= Mediaset.last.id %>',
      data: {includeFirst:true, persona:'<%= @persona.id %>', featured:true }, 
      dataType: 'script'
    });
  <% end %>

  //endless scrolls of mediasets, hua hahahahahh
  $(document).endlessScroll({
    fireOnce: true,
    fireDelay: 500, 
    bottomPixels: 250, 
    intervalFrequency: 100, 
    ceaseFireOnEmpty: false, 
    ceaseFire: function(){
      return $('.last-div').length ? false : true;
    }, 
    loader: '<div>loading...</div>', 
    callback: function(){
        $.ajax({
          url: '/mediasets/get_more/'+$('.endless-mediaset').attr('last'), 
          data: { persona:'<%= @persona.id %>', featured:isFeatured } ,
          dataType: 'script'
        });
    }, 
    ceaseFire: function(s){
      s<5 ? false : true;  
    }
  });

  $(document).ready( function(){
    //handle nav bar 
    $('#mediasetTypeSelectorTab li').click( function(){
      $('.active').toggleClass('active');
      $(this).toggleClass('active');

      //empty out and repopulate
      $('.last-div').empty();
      isFeatured = $('.recentlyFeatured').hasClass('active') ? 'true' : ['true', 'false'];
      <% if !@persona.mediasets.empty? then %>
        $('.endless-mediaset').attr('last', '<%= Mediaset.last.id %>');
      <% end %>
      $.ajax({
        url: '/mediasets/get_more/'+ $('.endless-mediaset').attr('last'),
        data: { persona:'<%= @persona.id %>', featured:isFeatured, includeFirst:true }, 
        dataType: 'script'
      });
    });

    //manually load more mediasets
    $('#getMoreSets').click( function(){
      $.ajax({
        url: '/mediasets/get_more/'+ $('.endless-mediaset').attr('last') , 
        data: { featured:isFeatured },
        dataType: 'script'
      });
    });

  });
</script>
