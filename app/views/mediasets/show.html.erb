<%- model_class = Mediaset -%>
<% content_for :title, @persona.screen_name + ' - mediaset' %>
<% @focus = 'mediaset' %>
<%= render "common/personaHeaderBar" %>

<div class="navbar">
  <div class="navbar-inner">
    <ul class="nav" id="mediasetTypeSelectorTab">
      <li class="divider-vertical"></li>
      <% if persona_signed_in? && current_persona.screen_name == params[:id] %>
        <li class="divider-vertical"></li>
        <li><%= link_to 'New', new_mediaset_path %></li>
        <li class="divider-vertical"></li>
      <% end %>
      <% if !@persona.mediasets.empty? then %>
        <li class="mediaset-selector active" id="recentlyFeatured"><a href="#">Featured</a></li>
        <li class="mediaset-selector" id="recentlyRaw"><a href="#">Raw</a></li>
      <% end %>
    </ul>
  </div>
</div>

<% if @persona.mediasets.empty? then %>
  <div class="well">
    <% if @persona.photos.empty? then %>
      <%= link_to 'Upload', new_photo_path %> some new photos to create a mediaset
    <% else %>
      <%= link_to 'Create', new_mediaset_path %> some new mediaset to help organize and showcase your photos
    <% end %>
  </div>
<% else %>
  <div class="row-fluid endless-mediaset" last="<%= Mediaset.last.id %>">
    <div class="last-div endless_scroll_inner_wrap" id="last-frame"></div>
  </div>
  <div class="row-fluid">
    <%= button_tag 'Get More Mediasets', :type => 'button', :class=>'btn btn-primary', :id=>'getMoreSets' %>
  </div>
<% end %>
<script type="text/javascript">
  <% if !@persona.mediasets.empty? then %>
    isFeatured = true
    $.ajax({
      url: '/mediasets/get_more/<%= Mediaset.last.id %>',
      data: {includeFirst:true, persona:'<%= @persona.id %>', featured:true }, 
      dataType: 'script'
    });
  <% end %>

  //endless scrolls of mediasets, hua hahahahahh
  $(document).endlessScroll({
    fireOnce: true,
    fireDelay: 500, 
    bottomPixels: 250, 
    intervalFrequency: 100, 
    ceaseFireOnEmpty: false, 
    ceaseFire: function(){
      return $('.last-div').length ? false : true;
    }, 
    loader: '<div>loading...</div>', 
    callback: function(){
        $.ajax({
          url: '/mediasets/get_more/'+$('.endless-mediaset').attr('last'), 
          data: { persona:'<%= @persona.id %>', featured:isFeatured } ,
          dataType: 'script'
        });
    }, 
    ceaseFire: function(s){
      s<5 ? false : true;  
    }
  });

  $(document).ready( function(){
    $('.last-div').css('min-height', $(window).height());

    //handle nav bar 
    $('#mediasetTypeSelectorTab').find('.mediaset-selector').click( function(event){
      event.preventDefault(); 
      $(this).parent().find('.active').toggleClass('active');
      $(this).toggleClass('active');

      //empty out and repopulate
      $('.last-div').empty();
      isFeatured = $('#recentlyFeatured').hasClass('active') ? 'true' : ['true', 'false'];
      <% if !@persona.mediasets.empty? then %>
        $('.endless-mediaset').attr('last', '<%= Mediaset.last.id %>');
      <% end %>
      $.ajax({
        url: '/mediasets/get_more/'+ $('.endless-mediaset').attr('last'),
        data: { persona:'<%= @persona.id %>', featured:isFeatured, includeFirst:true }, 
        dataType: 'script'
      });
    });

    //manually load more mediasets
    $('#getMoreSets').click( function(){
      $.ajax({
        url: '/mediasets/get_more/'+ $('.endless-mediaset').attr('last') , 
        data: { featured:isFeatured, persona:'<%= @persona.id %>' },
        dataType: 'script'
      });
    });

  });
</script>
