<%- model_class = Persona -%>
<% content_for :title, @persona.screen_name + ' profile' %>
<% @focus = 'profile' %>
<%= render "common/personaHeaderBar" %>

<div class="row-fluid">
  <div class="span3 well">
    <div class="row-fluid">
      <dl class="dl-horizontal">
        <% if persona_signed_in? && current_persona != @persona then %>
          <dt><strong>Tracking:</strong></dt>
          <dd class="trackBox">
          <% if current_persona.tracks 'persona', @persona then %>
            Following <%= @persona.screen_name %> - <%= link_to 'Unfollow', follower_untrack_path('persona', @persona), 
              :remote=> true, :method=> :post %>
          <% else %>
            <%= link_to 'Track photos by ' + @persona.screen_name, follower_track_path('persona', @persona ), 
              :remote=>true, :method => :post %>
          <% end %>
          </dd>
        <% end %>
        <dt><strong><%= model_class.human_attribute_name(:realname) %>:</strong></dt>
        <dd><%= @persona.realname.nil? ? 'Not set' : @persona.realname %></dd>
        <dt><strong><%= model_class.human_attribute_name(:screen_name) %>:</strong></dt>
        <dd><%= @persona.screen_name %></dd>
        <dt><strong><%= model_class.human_attribute_name(:premium) %>:</strong></dt>
        <dd>
          <%= @persona.premium? ? 
            ('Yes - '+ 
              link_to( 'Extend Premium Membership', persona_upgrade_acc_path(@persona.screen_name)) 
            ).html_safe :
            ('No - '+ link_to('Buy Premium Membership', persona_upgrade_acc_path(@persona.screen_name)) ).html_safe 
          %>
        </dd>
        <% if @persona.premium? then %>
          <dt><strong>Premium Since:</strong></dt>
          <dd><%= I18n.l @persona.premiumSince %></dd>
        <% end %>
        <% if persona_signed_in? && current_persona == @persona && @persona.premium? then %>
          <dt><strong>Premium Expiration:</strong></dt>
          <dd><%= I18n.l @persona.premiumExpire %></dd>
        <% end %>
      </dl>
    </div>
    <div class="row-fluid">
      <h4>Recent Tags</h4>
      <ul>
      <% @persona.photos.tag_counts.order('id desc').limit(20).each do |tag| %>
        <li style="display:inline;">
          <%= link_to tag.name, persona_show_tag_path(@persona.screen_name, tag.name) %>
        </li>
      <% end %>
      </ul>
    </div>
    <% if persona_signed_in? && @persona == current_persona && !@persona.premium? then %>
      <h4>Usage</h4>
      <div class="text-right">
        <%= number_to_human_size(@bandwidth, :precision => 2) %> of 300 MB
      </div>
      <div class="progress img-polaroid">
        <% bar_width = @exceed_bandwidth ? '100%' : number_to_percentage(@bandwidth/300.to_f/1024/1024*100, :precision => 0) %>
        <div class="bar <%= @exceed_bandwidth ? 'bar-danger' : '' %>" style="width: <%= bar_width %>;"></div>
      </div>
    <% end %>
    <div class="row-fluid">
      <h4>Followers (<%= Follower.where(:tracked_object_id => @persona.id, :tracked_object_type => 'persona').count %>)</h4>
      <div class="row-fluid">
        <% @followers.each do |follower| %>
          <div class="pull-left" style="margin:4px 2px;">
            <%= link_to image_tag(
              follower.avatar.normal.url.nil? ? 'http://placehold.it/75x75' : follower.avatar.normal), 
              persona_path(follower.screen_name), :title => follower.screen_name, :class=>'row-fluid' %> 
          </div>
        <% end %>
      </div>
      <div class="row-fluid">
        <% if @followers.count == 0 then %>
          <p><%= @persona.screen_name %> has no followers....</p>
        <% else %>
          <%= link_to 'see more...', follower_path(@persona.screen_name), :class=>'btn btn-mini' %>
        <% end %>
      </div>
    </div>
    <div class="row-fluid">
      <h4>Following (<%= @persona.followers.count %>)</h4>
      <div class="row-fluid">
        <% @following.each do |follower| %>
          <div class="pull-left" style="margin:4px 2px;">
            <%= link_to image_tag(follower.avatar.normal.url.nil? ? 'http://placehold.it/75x75' : follower.avatar.normal), 
              persona_path(follower.screen_name), :title => follower.screen_name, 
              :class => 'row-fluid' %>
          </div>
        <% end %>
      </div>
      <div class="row-fluid">
        <% if @following.count == 0 then %>
          <p><%= @persona.screen_name %> is not following anybody<p>
        <% else %>
          <%= link_to 'see more...', follower_path(@persona.screen_name), :class=>'btn btn-mini' %>
        <% end %>
      </div>
    </div>
  </div>
  <div class="span9">
    <div>
      <h2>Activity</h2>
      <% if @activity.empty? then %>
        <div class="hero-unit">
            <h3>Nothing to see yet</h3>
          <% if persona_signed_in? && @persona == current_persona then %>
            <p>Start <%= link_to 'uploading', new_photo_path %> photos</p>
          <% end %>
        </div>
      <% else %>
      <table class="table table-bordered table-striped table-hover">
        <tbody>
        <% @activity.each do |item| %>
          <tr><td>
            <div class="row-fluid">
              <ul>
              <% activity = String.new %>
              <% item[:activity].each do |act| %>
                <% if act[:event] == 'create' then %>
                  <% if act[:item] == 'Photo' then %>
                    <% activity = 'Uploaded ' + (pluralize act[:count], 'photo') %>
                  <% elsif act[:item] == 'Mediaset' then %>
                    <% 
                      activity = 'Created ' + Mediaset.find( act[:id]).map{ 
                        |x| link_to x.title, view_sets_path(@persona.screen_name, x.id) 
                      }.to_sentence 
                    %>
                  <% elsif act[:item] == 'MediasetPhoto' then %>
                    <% 
                      activity = 'Added ' + (pluralize act[:count], 'photo') + ' to ' +
                        Mediaset.find( MediasetPhoto.find(act[:id]).map{ |x| x.mediaset_id } ).
                          map{ |x| link_to x.title, view_sets_path(@persona.screen_name, x.id) }.to_sentence
                    %>
                  <% end %> 
                <% elsif act[:event] == 'featured' then %>
                  <% if act[:item] == 'Photo' then %> 
                    <% activity = 'Featured ' + pluralize(act[:count], 'photo') %>
                  <% elsif act[:item] == 'Mediaset' then %>
                    <% 
                      activity = 'Featured ' + Mediaset.find(act[:id]).map{ 
                        |x| link_to x.title, view_sets_path(@persona.screen_name, x.id) }.to_sentence 
                    %>
                  <% end %>
                <% elsif act[:event] == 'update' then %>
                  <% if act[:item] == 'MediasetPhoto' then %>
                    <% 
                      activity = 'Updated ' + Mediaset.find( 
                        MediasetPhoto.find(act[:id]).map{ |x| x.mediaset_id}.uniq 
                      ).map{ |x| link_to x.title, view_sets_path(@persona.screen_name, x.id) }.to_sentence 
                    %>
                  <% end %>
                <% elsif act[:event] == 'up_votes' then %>
                  <% 
                    activity = 'Voted on '+ (act[:item] == 'Photo' ? 'photos' : 'sets') + ' from ' + act[:id].map{ 
                      |x| Photo.find(x).persona_id 
                    }.uniq.map{ |x| Persona.find(x) }.map { 
                      |x| link_to x.screen_name, persona_path(x.screen_name) 
                    }.to_sentence.html_safe 
                  %> 
                <% end %>
                <% if !activity.empty? then %>
                  <li><%= activity.html_safe %></li>
                <% end %>
              <% end %>
              </ul>
            </div>
            <div class="row-fluid">
              <% Photo.where( :id => 
                  item[:activity].select{ |x|
                    (x[:item] == 'Photo' && ['featured', 'update', 'create', 'up_votes'].include?(x[:event]) )
                  }.map{ |x| x[:id] } +
                  MediasetPhoto.find(
                    item[:activity].select{ |x|
                      x[:item] == 'MediasetPhoto' && x[:event] == 'create'
                    }.map{ |x| x[:id]}
                  ).map{ |x| x[:photo_id] } +
                  Mediaset.find(
                    item[:activity].select{ |x|
                      x[:item] == 'Mediaset' && (['featured', 'up_votes'].include?(x[:event]) )
                    }.map{ |x| x[:id]}
                  ).map{ |set| set.photos.map{ |x| x[:id] } }.map{ |x| x[0..2] }
                ).limit(16).each do |photo| 
              %>
                <%= link_to image_tag(photo.avatar.square200, :class=>'img-polaroid', :style=>'margin:2px 0px;' ), 
                  photo_view_path(Persona.find(photo.persona_id).screen_name, photo)
                %>
              <% end %>
            </div>
            <div class="row-fluid">
              <%= distance_of_time_in_words item[:first_activity].to_i, DateTime.now.to_i %> ago
            </div>
          </td></tr>
        <% end %>
        </tbody>
      </table>
      <% end %>
    </div>
  </div>
</div>
<script type="text/javascript">
  $.ajax({
    url: '/photos/get_more/<%= Photo.last.id %>',
    data: { limit:10, mediatype:'featured',  author:'<%= @persona.screen_name %>', includeFirst:'true', size:'tiny', featured:true },
    dataType: 'script'
  });
</script>
