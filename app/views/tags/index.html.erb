<% if persona.nil? then %> 
  <% content_for :title, 'trendy tags' %>
  <div class="page-header">
    <h1><i class="icon-tags"></i> Tags</h1>
  </div>
<% else %>
  <% content_for :title, persona.screen_name + ' - tags' %>
  <% @focus = 'tags' %>
  <%= render :partial => "common/personaHeaderBar" %>
<% end %>

<div class="row-fluid navbar">
  <div class="navbar-inner">
    <ul class="nav" id="trendytags">
      <li class="active" id="recentTags"><a href="#">Recent</a></li>
      <li id="trendyTags"><a href="#">Trending</a></li>
    </ul>
  </div>
</div>
<div id="tagsResults" class"row-fluid">
  <div class="span6 offset4">
    <table class="table table-bordered table-striped table-hover">
      <thead>
        <tr>
          <th>Tag</th>
        </tr>
      </thead>
      <tbody id="tagcontent">
      <% tags.each do |tag| %>
        <tr>
          <td>
            <h3><%= link_to tag, tag_path(tag) %></h3>
            <div class="accordion" id="accordion-<%= tag %>">
              <div class="accordion-group">
                <div class="accordion-heading">
                    <%= link_to '<i class="icon-chevron-down"></i>'.html_safe, '#body-'+tag, 
                      :class=>'accordion-toggle', :'data-toggle'=> 'collapse', 
                      :'data-parent'=> '#accordion-'+tag %>
                </div>
                <div id="body-<%= tag %>" class="accordion-body collapse" tag="<%= tag %>" >
                  <div class="accordion-inner">
                    <div class="row-fluid"id="accordion-inner-<%= tag %>" >
                    </div>
                    <div class="row-fluid">
                      <%= link_to 'See more...', tag_path(tag) , :class=>'btn btn-mini btn-info' %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </div>
</div>
<script type="text/javascript">
  $(document).ready( function(){

    //load tag pictures where loaded
    $('.collapse').on('shown', function(){
      $.ajax({
        url: '/photos/get_more/0', 
        data: { size:'square100', mediatype:'tagset', tag:$(this).attr('tag'), 
          targetDiv:'#accordion-inner-'+$(this).attr('tag'), includeFirst:true, showCaption:false, 
          showIndicators:false
        }  
      });
    });

    $('#tagsResults').css('min-height', $(window).height()); 
    var sendParams = { mode: 'recent' } 

    //reload when the tab changes
    $('#trendytags li').click( function(event){
      event.preventDefault();
      $('.active').toggleClass('active');
      $(this).toggleClass('active');
      sendParams['mode'] = $('#recentTags').hasClass('active') ? 'recent' : 'trending';

      <% if !persona.nil? then %>
        sendParams['persona_range'] = '<%= persona.id %>';
      <% end %> 

      //reload tags
      $('#tagcontent').empty();
      $.ajax({
        url: '/tags/get_more',
        data: sendParams, 
        dataType: 'script'
      });
    });

  });
</script>
